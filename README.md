# AprilTagç‹¬ç«‹æ£€æµ‹åº“

è¿™æ˜¯ä¸€ä¸ªåŸºäºpupil-apriltagsåº“çš„AprilTagè¯†åˆ«å·¥å…·åŒ…ï¼Œç”¨äºæ‘„åƒå¤´ä¸­AprilTagçš„æ£€æµ‹å’Œè·Ÿè¸ªã€‚

## ä¾èµ–åº“

- Python 3.6+
- OpenCV
- NumPy
- pupil-apriltags

## å®‰è£…

1. ç¡®ä¿å·²å®‰è£…Pythonç¯å¢ƒ
2. å®‰è£…å¿…è¦çš„ä¾èµ–ï¼š

```bash
pip install opencv-python numpy pupil-apriltags
```

## ä½¿ç”¨æ–¹æ³•

### åŸºæœ¬ç”¨æ³•

```python
import cv2
from apriltag import Detector, DetectorOptions

# åˆ›å»ºæ£€æµ‹å™¨
options = DetectorOptions(
    families="tag36h11",  # æ ‡ç­¾å®¶æ—
    border=1,             # æ ‡ç­¾è¾¹æ¡†å¤§å°
    nthreads=4,           # çº¿ç¨‹æ•°é‡
    quad_decimate=1.0,    # å›¾åƒä¸‹é‡‡æ ·ç³»æ•°
    quad_blur=0.0,        # é«˜æ–¯æ¨¡ç³Šç³»æ•°
    refine_edges=True     # æ˜¯å¦ç²¾ç»†åŒ–è¾¹ç¼˜
)
detector = Detector(options)

# è¯»å–å›¾åƒ
img = cv2.imread("test_image.jpg")
gray = cv2.cvtColor(img, cv2.COLOR_BGR2GRAY)

# æ£€æµ‹AprilTag
detections = detector.detect(gray)

# æ˜¾ç¤ºæ£€æµ‹ç»“æœ
for detection in detections:
    print(f"æ ‡ç­¾å®¶æ—: {detection.tag_family}, ID: {detection.tag_id}")
    print(f"ä½ç½®: {detection.center}")
    print(f"è§’ç‚¹: {detection.corners}")
```

### ç»˜åˆ¶æ£€æµ‹ç»“æœ

```python
import numpy as np
from apriltag import draw_detection_results

# ç›¸æœºå†…å‚çŸ©é˜µå’Œç•¸å˜ç³»æ•°
K = np.array([[800, 0, 320], [0, 800, 240], [0, 0, 1]], dtype=np.float32)
D = np.zeros((4, 1), dtype=np.float32)

# ç»˜åˆ¶æ£€æµ‹ç»“æœ
result_img = draw_detection_results(img, detections, K, D, tag_size=0.1)

# æ˜¾ç¤ºç»“æœ
cv2.imshow("AprilTagæ£€æµ‹", result_img)
cv2.waitKey(0)
```

### è¿è¡Œæµ‹è¯•è„šæœ¬

æä¾›äº†ä¸€ä¸ªç®€å•çš„æµ‹è¯•è„šæœ¬ï¼Œå¯ä»¥ç”¨äºéªŒè¯AprilTagæ£€æµ‹åŠŸèƒ½ï¼š

```bash
python test_apriltag.py
```

è¿™å°†æ‰“å¼€ç”µè„‘é»˜è®¤æ‘„åƒå¤´å¹¶å®æ—¶æ£€æµ‹AprilTagã€‚æŒ‰"q"é”®é€€å‡ºã€‚

## æ”¯æŒçš„æ ‡ç­¾å®¶æ—

pupil-apriltagsåº“æ”¯æŒä»¥ä¸‹æ ‡ç­¾å®¶æ—ï¼š
- tag36h11 (é»˜è®¤)
- tag25h9
- tag16h5
- tagCircle21h7
- tagCircle49h12
- tagStandard41h12
- tagStandard52h13
- tagCustom48h12

## æ³¨æ„äº‹é¡¹

- ä¸ºè·å¾—æ›´å¥½çš„æ€§èƒ½ï¼Œå¯ä»¥è°ƒæ•´DetectorOptionsä¸­çš„å‚æ•°
- å¯¹äºè®¡ç®—èµ„æºæœ‰é™çš„è®¾å¤‡ï¼Œå¯ä»¥è€ƒè™‘å¢åŠ quad_decimateå‚æ•°æ¥é™ä½è®¡ç®—å¤æ‚åº¦
- ç¡®ä¿ä½¿ç”¨çš„AprilTagæ ‡è®°çš„å°ºå¯¸ä¸ä»£ç ä¸­çš„tag_sizeå‚æ•°åŒ¹é…
- ç»˜åˆ¶3Dåæ ‡è½´éœ€è¦å‡†ç¡®çš„ç›¸æœºå‚æ•°

## åŠŸèƒ½ç‰¹ç‚¹

- æ”¯æŒUSBæ‘„åƒå¤´å®æ—¶AprilTagæ£€æµ‹
- è®¡ç®—å¹¶æ˜¾ç¤ºæ ‡ç­¾çš„3Dä½å§¿(ä½ç½®å’Œæ–¹å‘)
- æ”¯æŒä¿å­˜åŸå§‹å’Œæ ‡è®°åçš„å›¾åƒ
- å¯è‡ªå®šä¹‰é…ç½®å’Œç›¸æœºå‚æ•°
- åŒ…å«å®Œæ•´çš„ç›¸æœºæ ‡å®šå·¥å…·
- ä¸ä¾èµ–ROSï¼Œæ˜¯åŸROSåŒ…çš„çº¯Pythonç‹¬ç«‹ç‰ˆæœ¬

## å®‰è£…æ­¥éª¤

### 1. å®‰è£…AprilTag Cåº“

AprilTagçš„Cåº“æ˜¯å¿…éœ€çš„ã€‚è¯·æŒ‰ç…§ä»¥ä¸‹æ­¥éª¤å®‰è£…ï¼š

#### Ubuntu/Debian:
```bash
sudo apt-get update
sudo apt-get install -y libapriltag-dev
```

#### Windows:
Windowsç”¨æˆ·éœ€è¦è‡ªè¡Œç¼–è¯‘æˆ–ä¸‹è½½é¢„ç¼–è¯‘çš„äºŒè¿›åˆ¶æ–‡ä»¶ï¼Œå¹¶ç¡®ä¿`apriltag.dll`åœ¨ç³»ç»ŸPATHä¸­æˆ–å½“å‰ç›®å½•ã€‚

### 2. å®‰è£…Pythonä¾èµ–

```bash
pip install -r requirements.txt  -i https://mirrors.tuna.tsinghua.edu.cn/pypi/web/simple
pip install pupil-apriltags -i https://mirrors.tuna.tsinghua.edu.cn/pypi/web/simple
```

## ä½¿ç”¨è¯´æ˜

### å¿«é€Ÿå¼€å§‹ (æ¨è)

æœ€ç®€å•çš„ä½¿ç”¨æ–¹å¼æ˜¯è¿è¡Œé›†æˆå·¥å…·ï¼Œå®ƒæä¾›äº†äº¤äº’å¼èœå•æ¥å¼•å¯¼æ‚¨å®Œæˆæ‰€æœ‰æ­¥éª¤ï¼š

```bash
python apriltag_tool.py
```

è¿™ä¸ªå·¥å…·ä¼šæä¾›èœå•é€‰é¡¹ï¼š
1. ç”Ÿæˆæ£‹ç›˜æ ¼æ ‡å®šæ¿
2. ç›¸æœºæ ‡å®š
3. AprilTagæ£€æµ‹
4. æŸ¥çœ‹å¸®åŠ©æ–‡æ¡£

åªéœ€æŒ‰ç…§èœå•æç¤ºæ“ä½œå³å¯å®Œæˆæ•´ä¸ªæµç¨‹ã€‚

### ç›¸æœºæ ‡å®š

åœ¨ä½¿ç”¨AprilTagæ£€æµ‹å‰ï¼Œå»ºè®®å…ˆè¿›è¡Œç›¸æœºæ ‡å®šï¼Œè·å–å‡†ç¡®çš„ç›¸æœºå‚æ•°ï¼š

```bash
# é¦–å…ˆç”Ÿæˆæ£‹ç›˜æ ¼æ ‡å®šæ¿
python create_chessboard.py --size 9x6 --square 100 --output chessboard.png --dpi 300

# æ‰“å°æ£‹ç›˜æ ¼å¹¶æµ‹é‡å®é™…æ–¹æ ¼å¤§å°ï¼Œç„¶åè¿›è¡Œæ ‡å®š
python camera_calibration.py --size 9x6 --square 0.025 --output config/camera/camera_info_1.yaml
```

å‚æ•°è¯´æ˜:

**æ£‹ç›˜æ ¼ç”Ÿæˆå·¥å…· (create_chessboard.py):**
- `--size`: æ£‹ç›˜æ ¼å†…è§’ç‚¹æ•°é‡ï¼Œå®½xé«˜ (é»˜è®¤: 9x6)
- `--square`: æ–¹æ ¼å¤§å°ï¼Œåƒç´  (é»˜è®¤: 100)
- `--output`: è¾“å‡ºæ–‡ä»¶è·¯å¾„ (é»˜è®¤: chessboard.png)
- `--dpi`: è¾“å‡ºå›¾åƒçš„DPI (é»˜è®¤: 300)ï¼Œå½±å“æ‰“å°å°ºå¯¸

**ç›¸æœºæ ‡å®šç¨‹åº (camera_calibration.py):**
- `--size`: æ£‹ç›˜æ ¼å†…è§’ç‚¹æ•°é‡ï¼Œå®½xé«˜ (é»˜è®¤: 9x6)
- `--square`: æ£‹ç›˜æ ¼æ–¹å—å¤§å°ï¼Œå•ä½ç±³ (é»˜è®¤: 0.025)
- `--output`: è¾“å‡ºæ–‡ä»¶è·¯å¾„ (é»˜è®¤: config/camera/camera_info_1.yaml)
- `--camera`: æ‘„åƒå¤´è®¾å¤‡ID (é»˜è®¤: 0)
- `--width`: æ‘„åƒå¤´æ•è·å®½åº¦ (é»˜è®¤: 1280)
- `--height`: æ‘„åƒå¤´æ•è·é«˜åº¦ (é»˜è®¤: 720)
- `--samples`: æ ‡å®šæ‰€éœ€æ ·æœ¬æ•°é‡ (é»˜è®¤: 20)
- `--preview`: æ ‡å®šå®Œæˆåé¢„è§ˆæ ¡æ­£æ•ˆæœ

æ ‡å®šè¿‡ç¨‹ï¼š
1. ç”Ÿæˆå¹¶æ‰“å°æ£‹ç›˜æ ¼æ ‡å®šæ¿
2. æµ‹é‡å®é™…æ–¹æ ¼å¤§å°ï¼ˆä»¥ç±³ä¸ºå•ä½ï¼‰
3. è¿è¡Œæ ‡å®šç¨‹åºï¼Œå°†æ£‹ç›˜æ ¼æ”¾åœ¨ç›¸æœºå‰ï¼Œä»ä¸åŒè§’åº¦é‡‡é›†æ ·æœ¬
4. ç¨‹åºä¼šè‡ªåŠ¨æ£€æµ‹æ£‹ç›˜æ ¼å¹¶æ”¶é›†æ ·æœ¬ï¼Œä¹Ÿå¯æŒ‰'s'é”®æ‰‹åŠ¨ä¿å­˜å½“å‰å¸§
5. æ”¶é›†è¶³å¤Ÿæ ·æœ¬åï¼Œç¨‹åºè‡ªåŠ¨è®¡ç®—ç›¸æœºå‚æ•°å¹¶ä¿å­˜åˆ°æŒ‡å®šæ–‡ä»¶

### AprilTagæ£€æµ‹

æ ‡å®šå®Œæˆåï¼Œå¯ä»¥è¿è¡ŒAprilTagæ£€æµ‹ç¨‹åºï¼š

```bash
python apriltag_detector.py
```

### é«˜çº§ç”¨æ³•

```bash
python apriltag_detector.py [é…ç½®æ–‡ä»¶è·¯å¾„] --camera ç›¸æœºID --width å®½åº¦ --height é«˜åº¦ --camera_info ç›¸æœºå‚æ•°æ–‡ä»¶
```

å‚æ•°è¯´æ˜:
- `é…ç½®æ–‡ä»¶è·¯å¾„`: AprilTagé…ç½®æ–‡ä»¶è·¯å¾„ (é»˜è®¤: `config/vision/tags_36h11_all.json`)
- `--camera`: æ‘„åƒå¤´è®¾å¤‡ID (é»˜è®¤: 0)
- `--camera_info`: ç›¸æœºå†…å‚æ–‡ä»¶è·¯å¾„ (é»˜è®¤: `config/camera/camera_info_1.yaml`)
- `--width`: æ‘„åƒå¤´æ•è·å®½åº¦ (é»˜è®¤: 1280)
- `--height`: æ‘„åƒå¤´æ•è·é«˜åº¦ (é»˜è®¤: 720)

### æŒ‰é”®æ§åˆ¶

- `q`: é€€å‡ºç¨‹åº

## é…ç½®æ–‡ä»¶è¯´æ˜

### AprilTagé…ç½®æ–‡ä»¶ (JSON)

ä½äº `config/vision/tags_36h11_all.json`ï¼ŒåŒ…å«ä»¥ä¸‹ä¸»è¦é…ç½®:

```json
{
    "AprilTagConfig": {
        "family": "tag36h11",      // æ ‡ç­¾å®¶æ—
        "size": 0.1,               // æ ‡ç­¾å°ºå¯¸(ç±³)
        "threads": 2,              // çº¿ç¨‹æ•°
        // å…¶ä»–æ£€æµ‹å‚æ•°...
    },

    "Archive": {
        "enable": true,            // æ˜¯å¦å¯ç”¨å­˜æ¡£
        "preview": true,           // æ˜¯å¦å®æ—¶é¢„è§ˆ
        "path": "./data/apriltag"  // å­˜æ¡£è·¯å¾„
        // å…¶ä»–å­˜æ¡£å‚æ•°...
    }
}
```
âœ… AprilTagConfig éƒ¨åˆ†ï¼šè¿™æ˜¯å…³äº AprilTag æ£€æµ‹å™¨æœ¬èº«çš„é…ç½®ã€‚

å‚æ•°	å«ä¹‰
family: "tag36h11"	ä½¿ç”¨çš„ AprilTag æ ‡ç­¾å®¶æ—ï¼Œtag36h11 æ˜¯ä¸€ç§å¸¸è§çš„ã€é«˜ç²¾åº¦æ ‡ç­¾å®¶æ—ã€‚
size: 0.1	æ ‡ç­¾åœ¨ç°å®ä¸–ç•Œä¸­çš„å®é™…è¾¹é•¿ï¼ˆå•ä½ï¼šç±³ï¼‰ï¼Œé€šå¸¸ç”¨äºä»å›¾åƒä¸­æ¢å¤çœŸå®çš„ä¸‰ç»´ä½ç½®ã€‚
threads: 2	ç”¨äºå¹¶è¡Œå¤„ç†çš„çº¿ç¨‹æ•°é‡ï¼ŒåŠ å¿«æ£€æµ‹é€Ÿåº¦ã€‚
max_hamming: 0	æœ€å¤§æ±‰æ˜è·ç¦»ï¼Œè¡¨ç¤ºè¯†åˆ«æ—¶å®¹å¿çš„æ ‡ç­¾ç¼–ç è¯¯å·®æ•°ï¼Œ0 è¡¨ç¤ºåªæ¥å—å®Œå…¨åŒ¹é…çš„æ ‡ç­¾ã€‚
z_up: true	åæ ‡ç³»çš„æ–¹å‘è®¾ç½®ï¼Œè‹¥ä¸º trueï¼Œè¡¨ç¤º Z è½´æœä¸Šï¼ˆé€‚ç”¨äºæŸäº› SLAM ç³»ç»Ÿï¼‰ã€‚
å›¾åƒé¢„å¤„ç†å‚æ•°ï¼š

å‚æ•°	å«ä¹‰
decimate: 1.0	å›¾åƒé™é‡‡æ ·ç³»æ•°ï¼Œ1.0 è¡¨ç¤ºä¸é™é‡‡æ ·ï¼›è®¾ç½®å°äº1å¯ä»¥åŠ é€Ÿä½†é™ä½ç²¾åº¦ã€‚
blur: 1.0	åº”ç”¨é«˜æ–¯æ¨¡ç³Šçš„ç¨‹åº¦ï¼Œç”¨äºå‡å°‘å™ªå£°ã€‚
refine_edges: 1	æ˜¯å¦ä¼˜åŒ–æ£€æµ‹è¾¹ç¼˜ï¼Œ1 è¡¨ç¤ºå¼€å¯ï¼Œæå‡ç²¾åº¦ä½†å¢åŠ è®¡ç®—é‡ã€‚
debug: 0	æ˜¯å¦å¼€å¯è°ƒè¯•ä¿¡æ¯ï¼Œ0 è¡¨ç¤ºå…³é—­è°ƒè¯•è¾“å‡ºã€‚
ğŸ“ Archive éƒ¨åˆ†ï¼šæ§åˆ¶æ£€æµ‹ç»“æœçš„ä¿å­˜ä¸é¢„è§ˆã€‚

å‚æ•°	å«ä¹‰
enable: true	æ˜¯å¦å¼€å¯å½’æ¡£åŠŸèƒ½ï¼ˆä¿å­˜å›¾åƒå’Œæ£€æµ‹ç»“æœï¼‰ã€‚
preview: true	æ£€æµ‹åæ˜¯å¦æ˜¾ç¤ºæ£€æµ‹ç»“æœçš„å›¾åƒé¢„è§ˆçª—å£ã€‚
preview_delay: 3000	é¢„è§ˆå›¾åƒæ˜¾ç¤ºçš„æ—¶é—´ï¼ˆæ¯«ç§’ï¼‰ï¼Œè¿™é‡Œæ˜¯ 3 ç§’ã€‚
save_raw: false	æ˜¯å¦ä¿å­˜åŸå§‹è¾“å…¥å›¾åƒï¼Œfalse è¡¨ç¤ºä¸ä¿å­˜ã€‚
save_pred: true	æ˜¯å¦ä¿å­˜åŒ…å«æ£€æµ‹ç»“æœçš„å›¾åƒï¼ˆå¸¦æ ‡ç­¾è¾¹æ¡†å’ŒIDï¼‰ã€‚
path: "./data/apriltag"	ä¿å­˜å›¾åƒå’Œæ•°æ®çš„è·¯å¾„ã€‚

### ç›¸æœºå‚æ•°æ–‡ä»¶ (YAML)

ä½äº `config/camera/camera_info_1.yaml`ï¼ŒåŒ…å«ç›¸æœºå†…å‚å’Œç•¸å˜ç³»æ•°ï¼š

```yaml
image_width: 1280
image_height: 720
camera_matrix:
  rows: 3
  cols: 3
  data: [fx, 0, cx, 0, fy, cy, 0, 0, 1]
distortion_coefficients:
  rows: 1
  cols: 5
  data: [k1, k2, p1, p2, k3]
# å…¶ä»–å‚æ•°...
```

## å¸¸è§é—®é¢˜

1. **æ‰¾ä¸åˆ°apriltagåº“**
   
   ç¡®ä¿å·²æ­£ç¡®å®‰è£…apriltagåº“ï¼Œå¹¶ä¸”åº“æ–‡ä»¶åœ¨ç³»ç»Ÿä¸­å¯ä»¥æ‰¾åˆ°ã€‚

2. **ç›¸æœºæ— æ³•æ‰“å¼€**
   
   æ£€æŸ¥ç›¸æœºè®¾å¤‡IDæ˜¯å¦æ­£ç¡®ï¼Œä»¥åŠç›¸æœºæ˜¯å¦è¢«å…¶ä»–ç¨‹åºå ç”¨ã€‚

3. **æ£€æµ‹ç»“æœä¸å‡†ç¡®**
   
   ç¡®ä¿æ‚¨çš„ç›¸æœºå·²æ­£ç¡®æ ‡å®šï¼Œå¹¶ä¸”é…ç½®æ–‡ä»¶ä¸­çš„æ ‡ç­¾å°ºå¯¸æ­£ç¡®ã€‚

4. **æ ‡å®šè¿‡ç¨‹ä¸­æ‰¾ä¸åˆ°æ£‹ç›˜æ ¼**
   
   ç¡®ä¿æ£‹ç›˜æ ¼å¹²å‡€å¹³æ•´ï¼Œå…‰ç…§å‡åŒ€ï¼Œé¿å…å¼ºåå…‰ã€‚å°½é‡ä½¿æ£‹ç›˜æ ¼å æ®ç”»é¢è¾ƒå¤§éƒ¨åˆ†ã€‚

## æ–‡ä»¶ç»“æ„è¯´æ˜

```
apriltag_standalone/
â”œâ”€â”€ apriltag.py              # AprilTagæ£€æµ‹åº“æ ¸å¿ƒä»£ç 
â”œâ”€â”€ apriltag_detector.py     # AprilTagæ£€æµ‹ä¸»ç¨‹åº
â”œâ”€â”€ apriltag_tool.py         # é›†æˆå·¥å…·å¯åŠ¨èœå•
â”œâ”€â”€ camera_calibration.py    # ç›¸æœºæ ‡å®šç¨‹åº
â”œâ”€â”€ create_chessboard.py     # æ£‹ç›˜æ ¼ç”Ÿæˆå·¥å…·
â”œâ”€â”€ configs.py               # é…ç½®æ–‡ä»¶å¤„ç†
â”œâ”€â”€ config/                  # é…ç½®ç›®å½•
â”‚   â”œâ”€â”€ camera/              # ç›¸æœºé…ç½®
â”‚   â”‚   â””â”€â”€ camera_info_1.yaml  # ç›¸æœºå‚æ•°
â”‚   â””â”€â”€ vision/              # è§†è§‰é…ç½®
â”‚       â””â”€â”€ tags_36h11_all.json # AprilTagé…ç½®
â”œâ”€â”€ README.md                # è¯´æ˜æ–‡æ¡£
â””â”€â”€ requirements.txt         # Pythonä¾èµ–
```

## æŠ€æœ¯è¯´æ˜

æœ¬é¡¹ç›®æ˜¯ä»ROS AprilTagæ£€æµ‹åŒ…ç§»æ¤çš„ç‹¬ç«‹ç‰ˆæœ¬ï¼Œç§»é™¤äº†ROSä¾èµ–ï¼Œä¿ç•™äº†æ ¸å¿ƒåŠŸèƒ½ã€‚
ä¸»è¦ä½¿ç”¨äº†ä»¥ä¸‹æŠ€æœ¯ï¼š

- OpenCV: å›¾åƒå¤„ç†ã€ç›¸æœºæ ‡å®šå’Œå§¿æ€ä¼°è®¡
- AprilTag Cåº“: æ ‡ç­¾æ£€æµ‹
- SciPy: æ—‹è½¬çŸ©é˜µå’Œå››å…ƒæ•°è½¬æ¢

## è®¸å¯è¯

æœ¬é¡¹ç›®åŸºäºMITè®¸å¯è¯ 